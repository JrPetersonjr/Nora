/*! Local DOMPurify-compatible sanitizer.
   Avoids external CDN fetches so privacy/tracking policies do not break startup. */
(function () {
  if (window.DOMPurify && typeof window.DOMPurify.sanitize === 'function') {
    return;
  }

  const DEFAULT_ALLOWED_TAGS = new Set([
    'B', 'I', 'EM', 'STRONG', 'A', 'P', 'BR', 'UL', 'OL', 'LI', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6'
  ]);
  const DEFAULT_ALLOWED_ATTR = new Set(['href', 'title', 'target', 'rel']);

  function sanitizeHtml(input, options) {
    if (typeof input !== 'string' || input.length === 0) {
      return '';
    }

    const allowedTags = new Set(
      Array.isArray(options && options.ALLOWED_TAGS)
        ? options.ALLOWED_TAGS.map((tag) => String(tag).toUpperCase())
        : Array.from(DEFAULT_ALLOWED_TAGS)
    );
    const allowedAttrs = new Set(
      Array.isArray(options && options.ALLOWED_ATTR)
        ? options.ALLOWED_ATTR.map((attr) => String(attr).toLowerCase())
        : Array.from(DEFAULT_ALLOWED_ATTR)
    );

    const parser = new DOMParser();
    const doc = parser.parseFromString(input, 'text/html');

    doc.querySelectorAll('*').forEach((node) => {
      if (!allowedTags.has(node.tagName)) {
        node.replaceWith(doc.createTextNode(node.textContent || ''));
        return;
      }

      const attrs = Array.from(node.attributes);
      attrs.forEach((attr) => {
        const name = attr.name.toLowerCase();
        const value = attr.value || '';
        if (!allowedAttrs.has(name) || name.startsWith('on')) {
          node.removeAttribute(attr.name);
          return;
        }
        if (name === 'href' && /^(javascript|data):/i.test(value.trim())) {
          node.removeAttribute(attr.name);
          return;
        }
      });

      if (node.tagName === 'A' && node.hasAttribute('target')) {
        node.setAttribute('rel', 'noopener noreferrer');
      }
    });

    return doc.body.innerHTML;
  }

  window.DOMPurify = {
    sanitize: sanitizeHtml
  };
})();
